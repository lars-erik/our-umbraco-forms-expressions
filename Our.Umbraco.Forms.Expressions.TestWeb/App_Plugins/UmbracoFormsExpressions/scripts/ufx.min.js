angular.module("ufx",[]);angular.module("umbraco").requires.push("ufx"),function(){"use strict";function n(){return{replace:!0,require:["^ngModel"],restrict:"E",template:'<select ng-options="field.id as field.caption for field in fields"><\/select>',link:function(n){n.fields=n.model.fields}}}angular.module("ufx").directive("ufxField",[n])}(),function(){function n(n,t,i){function h(){u.setCompleters([u.keyWordCompleter,r.fieldCompleter,r.variableCompleter,r.functionCompleter])}function f(n,t){return t.value.toLowerCase()==="["+n.name.toLowerCase()+"]"}function e(n,t){var e=n.session.getLength(),r,f=[],u,i;for(t=t||"variable.parameter",u=0;u<e;u++)for(r=n.session.getTokens(u),i=0;i<r.length;i++)r[i].type===t&&f.push(r[i]);return f}function c(t){for(var r,u,i=0;i<t.length;i++){for(u=-1,r=0;r<n.fields.length;r++)if(f(n.fields[r],t[i])){u=r;break}u===-1&&n.fields.push({name:t[i].value.substring(1,t[i].value.length-1),value:0})}}function l(t){for(var r,u,i=n.fields.length-1;i>=0;i--){for(u=-1,r=0;r<t.length;r++)if(f(n.fields[i],t[r])){u=i;break}u===-1&&n.fields.splice(i,1)}}function o(n){var i=n.editor,t=e(i);t.length!==0&&(c(t),l(t),setTimeout(function(){n.$digest()},50))}var s=i.getApiUrl("ufx-program-evaluator","Run"),r={},u=ace.require("lib/ace-builds/src-min-noconflict/ext-language_tools");r.fieldCompleter={getCompletions:function(t,i,r,u,f){var e=i.getTokenAt(r.row,r.col),o=e&&e.type==="variable.parameter",s=_.uniq(n.fields.map(function(n){return n.name}).concat(n.model.fields.map(function(n){return n.caption}))),h=s.map(function(n){return{caption:n,value:o?n:"["+n+"]",meta:"field",type:"variable.parameter",score:100}});f(null,h)}};r.variableCompleter={getCompletions:function(n,t,i,r,u){var f=e(n,"variable.other"),o=f.map(function(n){return n.value}),s=_.uniq(o).map(function(n){return{caption:n,value:n,meta:"variable",type:"variable.other",score:100}});u(null,s)}};r.functionCompleter={getCompletions:function(n,t,i,r,u){var f=t.getMode().$highlightRules.functions.map(function(n){return{caption:n+"()",value:n,meta:"function",type:"support.function"}});u(null,f)}};n.run=function(){for(var r={},i=0;i<n.fields.length;i++)r[n.fields[i].name]=n.fields[i].value==null?"":n.fields[i].value;t.post(s,{Program:n.setting.value,Values:r}).then(function(t){var i,r;n.result=t.data;n.hasResult=t.data.Errors===null;for(i in n.result.SetFields)r=$.grep(n.fields,function(n){return function(t){return t.name.toLowerCase()===n.toLowerCase()}}(i))[0],r.value=n.result.SetFields[i],n.$broadcast("ufx.field.set",r.name)})};n.toggleFullScreen=function(){n.fullScreen=!0};n.closeFullScreen=function(){n.fullScreen=!1;n.$digest()};n.fullScreen=!1;n.fields=[];n.result={};n.hasResult=!1;n.populateFields=o;n.aceOpts={mode:"forms",theme:"chrome",onChange:o,require:["lib/ace-builds/src-min-noconflict/ext-language_tools"],advanced:{enableBasicAutocompletion:!0,enableLiveAutocompletion:!0}};h()}angular.module("ufx").controller("ufx.program.controller",["$scope","$http","umbRequestHelper","assetsService",function(t,i,r,u){u.load(["lib/ace-builds/src-min-noconflict/ace.js","lib/ace-builds/src-min-noconflict/ext-language_tools.js"]).then(function(){if(angular.isUndefined(window.ace))throw new Error("ui-ace need ace to work... (o rly?)");else n(t,i,r,u)})}])}();define("ace/mode/forms_highlight_rules",["require","exports","module","ace/lib/oop","ace/lib/lang","ace/mode/text_highlight_rules"],function(n,t){"use strict";var r=n("../lib/oop"),u=n("./text_highlight_rules").TextHighlightRules,i=function(){var n="power|ceiling|floor|round|ifblank",t=this.createKeywordMapper({keyword:"if|else|end","constant.language":"true|false"},"variable.other",!0);this.$rules={start:[{token:"constant.numeric",regex:"[+-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"variable.parameter",regex:"\\[[^\\]]*\\]"},{token:"support.function",regex:n},{token:t,regex:"[a-zA-Z_$][a-zA-Z0-9_$]*\\b"},{token:"variable.other",regex:"w+"},{token:"keyword.operator",regex:"\\+|\\-|\\/|\\*|="},{token:"paren.lparen",regex:"[\\(]"},{token:"paren.rparen",regex:"[\\)]"},{token:"text",regex:"\\s+"}]};this.normalizeRules();this.functions=n.split("|")};r.inherits(i,u);t.FormsHighlightRules=i});define("ace/mode/forms",["require","exports","module","ace/lib/oop","ace/mode/text","ace/mode/forms_highlight_rules","ace/ext/language_tools"],function(n,t){var r=n("../lib/oop"),u=n("./text").Mode,f=n("./forms_highlight_rules").FormsHighlightRules,i=function(){this.HighlightRules=f};r.inherits(i,u),function(){this.lineCommentStart="#";this.$id="ace/mode/forms";this.getNextLineIndent=function(n,t){return this.$getIndent(t)}}.call(i.prototype);t.Mode=i});angular.module("ufx").directive("ufxFieldAnimation",[function(){var t=250,n=["borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderTopColor","borderRightColor","borderBottomColor","borderLeftColor","borderTopStyle","borderRightStyle","borderBottomStyle","borderLeftStyle"];return{restrict:"A",link:function(i,r,u){for(var e={},o,s,f=0;f<n.length;f++)e[n[f]]=r.css(n[f]);o=$.extend({backgroundColor:"rgb(90, 255, 90)"},e);s=$.extend({backgroundColor:"rgb(255, 255, 255)"},e);i.$on("ufx.field.set",function(n,i){i===u.ufxFieldAnimation&&r.animate(o,t,"easeOutCubic",function(){r.animate(s,t,"easeOutCubic",function(){r.css(e)})})})}}}]);